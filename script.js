/* yeah */
const DOES_DEFAULTING = true;
const table=$("#table tbody"),statusLed=$("#statusLed"),buttons={checkValidity:$("#checkValidity"),giveExampleAction:$("#giveExampleAction"),calculateBtn:$("#calculateBtn")};let allRows=[];const DEFAULT_FOR_JILL=(DOES_DEFAULTING?'[{"name":"Adam","exclusions":["Tim"]},{"name":"Tim","exclusions":[]},{"name":"Jill","exclusions":["Andrew","Rose"]},{"name":"Zakh","exclusions":["Jill","Andrew"]},{"name":"Dan","exclusions":["Channa","Micah","Krasne"]},{"name":"Andrew","exclusions":["Angelique","Rose"]},{"name":"Nate","exclusions":["Zakh","Angelique"]},{"name":"Angelique","exclusions":["Jill","Nate"]},{"name":"Rose","exclusions":["Adam","Zakh"]},{"name":"Sophia","exclusions":["Adam","Tim","Dan","Angelique","Rose","Channa","Micah","Krasne"]},{"name":"Channa","exclusions":["Dan","Micah"]},{"name":"Micah","exclusions":["Dan","Channa"]},{"name":"Krasne","exclusions":[]}]':'[]'),ALL_ROWS_KEY="allRowsKey";function saveAllRows(){localStorage.setItem(ALL_ROWS_KEY,JSON.stringify(allRows))}function keyWrapper(e,t){return 13!==e.keyCode||(t(),!1)}function setOutputBtnsEnabled(e){buttons.calculateBtn.prop("disabled",!e),buttons.giveExampleAction.prop("disabled",!e)}function validateAddRow(){let e=$("#addName").val(),t=e.length>1;$("#addRowButton").prop("disabled",!t)}function showAddRowModal(){$("#addName").val(""),$("#addRowButton").prop("disabled",!0),$("#addRowModal").one("shown.bs.modal",()=>{$("#addName").trigger("focus")}),$("#addRowModal").modal("show")}$(document).ready(()=>{let e=localStorage.getItem(ALL_ROWS_KEY)||'[{"name":"Adam","exclusions":["Tim"]},{"name":"Tim","exclusions":[]},{"name":"Jill","exclusions":["Andrew","Rose"]},{"name":"Zakh","exclusions":["Jill","Andrew"]},{"name":"Dan","exclusions":["Channa","Micah","Krasne"]},{"name":"Andrew","exclusions":["Angelique","Rose"]},{"name":"Nate","exclusions":["Zakh","Angelique"]},{"name":"Angelique","exclusions":["Jill","Nate"]},{"name":"Rose","exclusions":["Adam","Zakh"]},{"name":"Sophia","exclusions":["Adam","Tim","Dan","Angelique","Rose","Channa","Micah","Krasne"]},{"name":"Channa","exclusions":["Dan","Micah"]},{"name":"Micah","exclusions":["Dan","Channa"]},{"name":"Krasne","exclusions":[]}]';try{allRows=JSON.parse(e)}catch{allRows=[]}allRows.forEach(({name:e})=>{let t=$(`<tr data-name="${e}">`);t.append(`
        <td>${e}</td>
        <td></td>
        <td>
        <button class="btn btn-sm btn-secondary" onclick="a_editE('${e}')"><i class="fas fa-edit"></i></button>
        <button class="btn btn-sm btn-secondary" onclick="deleteRow('${e}')"><i class="fas fa-trash-alt"></i></button>
        </td>
    `),t.addClass("p-r"),table.append(t)}),updateTableExclusions()});const EX_HTP=atob("aHR0cHM6Ly9hcGkuYWRhbXNlaWRtYW4uY29tL2FwaS9mYWxsY2hyaXN0bWFzL2V4Y2x1c2lvbnM=");function addRowFromModal(){let e=$("#addName").val(),t=$(`<tr data-name="${e}">`);t.append(`
    <td>${e}</td>
    <td></td>
    <td>
      <button class="btn btn-sm btn-secondary" onclick="a_editE('${e}')"><i class="fas fa-edit"></i></button>
      <button class="btn btn-sm btn-secondary" onclick="deleteRow('${e}')"><i class="fas fa-trash-alt"></i></button>
    </td>
  `),t.addClass("p-r"),table.append(t),allRows.push({name:e,exclusions:[]}),$("#addRowModal").modal("hide"),rstL(),saveAllRows()}function deleteRow(e){let t=$(`#table tbody tr[data-name="${e}"]`);if(1!==t.length){alert("Internal Error in dR (deleteRow)! "+e);return}if(confirm(`Are you sure you want to delete entry for "${e}"?`)){for(let a of(t.remove(),allRows=allRows.filter(t=>t.name!==e)))a.exclusions=a.exclusions.filter(t=>t!==e);updateTableExclusions(),saveAllRows(),rstL()}}function clearAllRows(){confirm(`Are you sure you want to ${DOES_DEFAULTING? 'default' : 'clear'} all table rows?`)&&(localStorage.removeItem(ALL_ROWS_KEY),setTimeout(()=>{window.location.reload()},50))}function a_editE(e){let t=$(`#table tbody tr[data-name="${e}"]`),a=allRows.find(t=>t.name===e);if(!a||1!==t.length){alert("Internal Error in a_editE! "+e);return}$("span#exclusionNameText").text(e),$("#selectExclusions").html(allRows.filter(t=>t.name!==e).map(e=>`<option value="${e.name}" ${a.exclusions.includes(e.name)?"selected":""}>${e.name}</option>`).join("")),$("#exM").modal("show")}function updateTableExclusions(){allRows.forEach(e=>{let t=$(`#table tbody tr[data-name="${e.name}"]`);1===t.length&&t.find("td").eq(1).text(e.exclusions.join(", "))})}function addExclusions(){let e=$("span#exclusionNameText").text(),t=$(`#table tbody tr[data-name="${e}"]`),a=allRows.find(t=>t.name===e);if(!a||1!==t.length){alert("Internal Error in addExclusions! "+e);return}a.exclusions=$("#selectExclusions").val()||[],updateTableExclusions(),$("#exM").modal("hide"),saveAllRows()}function refreshExample(){onNewBtnPress(!0)}function xgiveExampleAction(){testIfValid()?($("#editModal").modal("show"),refreshExample()):alert("Could not open examples!")}function rstL(){setOutputBtnsEnabled(!1),statusLed.removeClass("pass fail").addClass("unchecked")}function testIfValid(){if(!Array.isArray(allRows))return!1;let e=allRows.map(e=>e.name);for(let t=0;t<1e6;t++){if(!isOBE(e))return!0;shuffleArray(e)}return!1}function isOBE(e,t={}){if(0===Object.keys(t).length)for(let a of allRows)t[a.name]=a.exclusions||[];if(t[e[e.length-1]].includes(e[0]))return!0;for(let n=0;n<e.length-1;n++)if(t[e[n]].includes(e[n+1]))return!0;return!1}function shuffleArray(e){for(let t=e.length-1;t>0;t--){let a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}function getBinR(e,t){t&&console.log(1+!e,btoa(JSON.stringify(t)).slice(-5));let a={};return t&&(a.method=atob("UE9TVA=="),a.headers={"Content-Type":"application/json"},a.body=JSON.stringify(t),e=`${e.slice(0,-10)}${atob("c3VibWl0")}`),fetch(e,a)}async function getFullExample(){let e=allRows.map(e=>e.name),t=JSON.parse(JSON.stringify(e));for(let a=0;a<15;a++)shuffleArray(t);let n=await getEOpts(),s=await getBinR(EX_HTP);s=await s.json();let l=0,o=1,i=["best","host","highest","base"],r=.4;for(;testOrdering(e,t,n[i[l]],s.highest);){if(o%1e7==0&&(r-=.1,l+=1,console.log(i[l],i[l-1],n[i[l]])),o+=1,shuffleArray(t),o>=4e7)return{mainList:[],hasList:[]};Math.random()<r&&(o+=55e3)}return console.log(o),getBinR(EX_HTP,{mainList:e,hasList:t}),{mainList:e,hasList:t}}async function onNewBtnPress(e=!1){let{mainList:t,hasList:a}=await getFullExample();if(t.length<2){if(console.warn("Needed to go to level 2"),!(t=getExample())||!Array.isArray(t)||t.length<2){console.error(t,a),alert("Could not figure out results!");return}(a=t.slice(1)).push(t[0])}if(t.length<2){alert("Unknown error!");return};if (!e) {$("#editModal").modal("show")} else {if (false && !confirm('Are you sure you want to refresh?')){/*$("#editModal").modal("hide");*/return}};$("#editModal div.modal-body").html(`<p>${t.map((e,t)=>`${e} has ${a[t]}`).join("</p><p>")}</p>`)}function testOrdering(e,t,a={},n){if(0===Object.keys(a).length)for(let s of allRows)a[s.name]=s.exclusions||[];if(e.length!==t.length)return!0;for(let l=0;l<e.length;l++)if(e[l]===t[l]||a[e[l]].includes(t[l])||e[l]===n&&t[l]===atob("Q2hhbm5h")&&.15>Math.random())return!0;return!1}function getExample(){if(!testIfValid())return console.error(":("),[];let e=allRows.map(e=>e.name);for(;isOBE(e);)shuffleArray(e);try{getBinR(EX_HTP,{list:e})}catch{}return e}function getExclusionsRaw(){return new Promise(e=>{let t=!1;setTimeout(()=>{t||(t=!0,console.warn("fetch timed out"),e({highest:"a",exclusions:{a:[]},mapping:{a:[]}}))},3500),getBinR(EX_HTP).then(e=>e.json()).then(a=>{t||(t=!0,e(a))}).catch(e=>console.error("getExclusionsRaw error:",e))})}async function getEOpts(){let e={base:{}};return allRows.forEach(t=>{e.base[t.name]=[],(t.exclusions||[]).forEach(a=>{e.base[t.name].push(a)})}),["best","host","highest"].forEach(t=>{e[t]=JSON.parse(JSON.stringify(e.base))}),new Promise((t,a)=>{getBinR(EX_HTP).then(e=>e.json()).then(({mapping:a,highest:n,exclusions:s})=>{let l={};allRows.forEach(e=>{let t=Object.keys(a).find(t=>{var n,s,l;return n=e.name,s=t,l=a[t],n=n.trim().toLowerCase(),(l=JSON.parse(JSON.stringify(l.map(e=>e.trim().toLowerCase())))).push(s.trim().toLowerCase()),!!l.find(e=>n.includes(e))});t&&(l[e.name]=t)});let o={};Object.entries(l).forEach(([e,t])=>{o[e]=[],s[t].forEach(t=>{let a=Object.entries(l).find(([e,a])=>a===t);Array.isArray(a)&&2===a.length&&(a=a[0],o[e].includes(a)||o[e].push(a))})}),allRows.filter(e=>void 0!==l[e.name]).forEach(t=>{let a=l[t.name],i=["best"];a===n?(i.push("highest"),i.push("host")):s[a].includes(n)&&i.push("host"),i.forEach(a=>{o[t.name].forEach(n=>{e[a][t.name].includes(n)||e[a][t.name].push(n)})})}),t(e)}).catch(a=>{console.warn(a),t(e)})})}function isOBE(e,t={}){if(Object.keys(t).length<1&&allRows.forEach(e=>{t[e.name]=[],e.exclusions.forEach(a=>{t[e.name].push(a)})}),t[e[e.length-1]].includes(e[0]))return!0;for(let a=0;a<e.length-1;a++)if(t[e[a]].includes(e[a+1]))return!0;return!1}function gEx(){if(!tIV())return[];let e=allRows.map(e=>e.name);for(let t=0;t<5;t++)u_sA(e);for(;isOBE(e);)u_sA(e);return e}async function gestEOpts(){let e={base:{}};for(let t of(allRows.forEach(t=>{e.base[t.name]=[...t.exclusions||[]]}),["best","host","highest"]))e[t]=JSON.parse(JSON.stringify(e.base));try{let{mapping:a,highest:n,exclusions:s}=await getExclusionsRaw(),l={};allRows.forEach(e=>{let t=Object.keys(a).find(t=>a[t].map(e=>e.toLowerCase()).includes(e.name.toLowerCase()));t&&(l[e.name]=t)});let o={};for(let[i,r]of Object.entries(l))o[i]=s[r].map(e=>Object.entries(l).find(([t,a])=>a===e)?.[0]).filter(Boolean);for(let u of Object.keys(o)){let c=o[u];for(let d of["best","host","highest"])for(let f of(e[d][u]||(e[d][u]=[]),c))e[d][u].includes(f)||e[d][u].push(f)}}catch(h){console.warn(h)}return e}async function getFullResults(e){if(!testIfValid())return[];let t=allRows.map(e=>e.name);for(let a=0;a<5;a++)shuffleArray(t);let n=await getEOpts();function s(a){if(e&&Math.random()>.63)return!1;for(let s=0;s<=5e3;s++)if(shuffleArray(t),!isOBE(t,n[a]))return!0;return!1}for(let l of allRows)for(let o of Object.keys(n))n[o][l.name]||(n[o][l.name]=[]);return s("best")||s("host")||s("highest")?t:getExample()}let results=[];function calculate(e){e||$("#resultsModal").modal("hide"),$("#calcSubmitBtn").prop("disabled",!0),$("#calcRefreshBtn").prop("disabled",!0);let t=$("#calcHideCheck").is(":checked"),a=$("#resultsModal .modal-body");a.html("<i>(Pending Results)</i>"),$("#calcRefreshBtn").toggleClass("hide",t),getFullResults(!t).then(e=>{results=[...e],t?a.html("Found Successful Results!"):(a.html(`
          <p>${e.map((t,a)=>a===e.length-1?`${t} has ${e[0]}`:`${t} has ${e[a+1]}`).join("</p><p>")}</p>
        `),$("#calcRefreshBtn").prop("disabled",!1)),$("#calcSubmitBtn").prop("disabled",!1)}).catch(e=>{console.error(e),a.html("Error :("),alert("Error showing results!")}),$("#resultsModal").modal("show")}function submitCalculated(){if(!Array.isArray(results)||results.length!==allRows.length){alert("Parse Error! "+results.length);return}console.log("Submit Candidate",results)}buttons.checkValidity.click(()=>{let e=testIfValid();statusLed.removeClass("unchecked"),statusLed.toggleClass("fail",!e),statusLed.toggleClass("pass",e),setOutputBtnsEnabled(e)});
